<div class="container">
  <header class="header">
    <div class="header-content">
      <svg class="aws-icon" viewBox="0 0 48 48" width="40" height="40">
        <circle cx="24" cy="24" r="20" fill="#FF9900"/>
        <circle cx="24" cy="24" r="16" fill="#232F3E"/>
        <rect x="15" y="18" width="18" height="12" rx="1.5" fill="#FF9900"/>
        <circle cx="24" cy="24" r="2" fill="#232F3E"/>
      </svg>
      <h1>AWS MFA Credentials</h1>
    </div>
    <button class="icon-btn" (click)="refreshAll()" title="Refresh">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
        <path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
      </svg>
    </button>
  </header>

  @if (error()) {
    <div class="alert alert-error">
      <span>{{ error() }}</span>
      <button class="close-btn" (click)="clearError()">&times;</button>
    </div>
  }

  @if (success()) {
    <div class="alert alert-success">
      <span>{{ success() }}</span>
      <button class="close-btn" (click)="clearSuccess()">&times;</button>
    </div>
  }

  <div class="main-content">
    <!-- Login Card -->
    <div class="card login-card">
      <h2>Authenticate with MFA</h2>

      <div class="form-group">
        <label for="profile">AWS Profile</label>
        <select
          id="profile"
          [ngModel]="selectedProfile()"
          (ngModelChange)="selectedProfile.set($event)"
        >
          @for (profile of profiles(); track profile.name) {
            <option [value]="profile.name">
              {{ profile.name }} ({{ profile.region }})
            </option>
          }
        </select>
      </div>

      <div class="form-group">
        <label for="token">MFA Token Code</label>
        <input
          id="token"
          type="text"
          [ngModel]="tokenCode()"
          (ngModelChange)="tokenCode.set($event)"
          placeholder="Enter 6-digit code"
          maxlength="6"
          (keypress)="onTokenKeyPress($event)"
        />
      </div>

      <button
        class="btn btn-primary"
        (click)="handleLogin()"
        [disabled]="loading() || !tokenCode()"
      >
        @if (loading()) {
          <span class="spinner"></span>
          Authenticating...
        } @else {
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
            <path d="M12.65 10A5.99 5.99 0 006 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 006.65-4H17v4h4v-4h3v-4H12.65zM6 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
          </svg>
          Login with MFA
        }
      </button>

      @if (getSelectedProfileInfo(); as profile) {
        <p class="mfa-serial">MFA: {{ profile.mfaSerial }}</p>
      }
    </div>

    <!-- Profiles Status Card -->
    <div class="card profiles-card">
      <h2>Profile Status</h2>

      <div class="profiles-list">
        @for (profile of profiles(); track profile.name) {
          @let status = getStatusForProfile(profile.name);
          <div class="profile-item" [class.authenticated]="status?.authenticated">
            <div class="profile-header">
              <div class="profile-info">
                @if (status?.authenticated) {
                  <svg class="status-icon success" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                } @else {
                  <svg class="status-icon error" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                  </svg>
                }
                <span class="profile-name">{{ profile.name }}</span>
                <span class="profile-region">{{ profile.region }}</span>
              </div>

              @if (status?.authenticated) {
                <div class="profile-actions">
                  <button class="icon-btn" (click)="handleViewCredentials(profile.name)" title="View credentials">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                      <path d="M12.65 10A5.99 5.99 0 006 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 006.65-4H17v4h4v-4h3v-4H12.65zM6 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    </svg>
                  </button>
                  <button class="icon-btn" (click)="handleExportEnvFile(profile.name)" title="Export to file">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                  </button>
                  <button class="icon-btn danger" (click)="handleClearCredentials(profile.name)" title="Clear credentials">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                  </button>
                </div>
              }
            </div>

            @if (status?.authenticated && status?.timeRemaining) {
              <div class="expiry-info">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                  <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                </svg>
                <span>Expires in: {{ status.timeRemaining }}</span>
              </div>
            }
          </div>
        } @empty {
          <p class="empty-message">
            No AWS profiles with MFA configured found.<br/>
            Add mfa_serial to your ~/.aws/config
          </p>
        }
      </div>
    </div>
  </div>

  <!-- Credentials Display -->
  @if (credentials(); as creds) {
    <div class="card credentials-card">
      <div class="credentials-header">
        <h2>Credentials: {{ creds.profile }}</h2>
        <div class="credentials-actions">
          <button class="btn btn-outline" (click)="handleCopyEnv()">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
              <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
            </svg>
            Copy as ENV
          </button>
          <button class="icon-btn" (click)="closeCredentials()">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="credentials-content">
        <div class="credential-item">
          <label>AWS_ACCESS_KEY_ID</label>
          <code>{{ creds.accessKeyId }}</code>
        </div>
        <div class="credential-item">
          <label>AWS_SECRET_ACCESS_KEY</label>
          <code>{{ creds.secretAccessKey.substring(0, 10) }}...</code>
        </div>
        <div class="credential-item">
          <label>AWS_SESSION_TOKEN</label>
          <code>{{ creds.sessionToken.substring(0, 30) }}...</code>
        </div>
      </div>
    </div>
  }

  <!-- CLI Usage -->
  <div class="card cli-card">
    <h2>CLI Usage</h2>
    <p class="cli-description">This extension also installs a CLI tool. Use it from your terminal:</p>
    <div class="cli-commands">
      <code>$ docker aws login -p {{ selectedProfile() }}</code>
      <code>$ docker aws run -- -it amazon/aws-cli s3 ls</code>
      <code>$ docker aws compose -- up -d</code>
      <code>$ eval $(docker aws env --export)</code>
    </div>
  </div>
</div>
